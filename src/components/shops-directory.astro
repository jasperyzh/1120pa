---
import shops from "../content/shops.json";

const categories = ["All", "Food", "Services", "Groceries"];
---

<div class="mb-4">
    <div class="d-flex justify-content-center gap-2 mb-4" id="filters">
        {
            categories.map((cat) => (
                <button
                    class="btn btn-outline-primary filter-btn"
                    data-filter={cat}
                >
                    {cat}
                </button>
            ))
        }
    </div>

    <div
        class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"
        id="shops-container"
    >
        {
            shops.map((shop) => (
                <div class="col shop-item" data-category={shop.category}>
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                {shop.name}{" "}
                                <span class="badge bg-secondary fs-6">
                                    {shop.category}
                                </span>
                            </h5>
                            <p class="card-text mb-1">üìç {shop.location}</p>
                            <p class="card-text mb-1">
                                <small class="text-body-secondary">
                                    ‚è∞ {shop.hours}
                                </small>
                            </p>

                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                {(() => {
                                    // Simple check if it looks like a mobile number (starts with 01, +601, 601)
                                    // Remove dashes and spaces first
                                    const cleanNum = shop.contact.replace(
                                        /[^\d+]/g,
                                        "",
                                    );
                                    const isMobile =
                                        cleanNum.startsWith("01") ||
                                        cleanNum.startsWith("601") ||
                                        cleanNum.startsWith("+601");

                                    // Format for WhatsApp: Needs 60 prefix, no +, no dashes
                                    let waNum = cleanNum.replace(/^\+/, "");
                                    if (waNum.startsWith("0"))
                                        waNum = "6" + waNum;

                                    return isMobile ? (
                                        <a
                                            href={`https://wa.me/${waNum}`}
                                            class="btn btn-success btn-sm"
                                            target="_blank"
                                        >
                                            <i class="bi bi-whatsapp" />{" "}
                                            WhatsApp
                                        </a>
                                    ) : (
                                        <a
                                            href={`tel:${shop.contact}`}
                                            class="btn btn-primary btn-sm"
                                        >
                                            <i class="bi bi-telephone" /> Call
                                        </a>
                                    );
                                })()}
                                {shop.delivery && (
                                    <span class="badge text-bg-info">
                                        Delivery
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            ))
        }
    </div>
</div>

<script>
    const filterBtns = document.querySelectorAll(".filter-btn");
    const shopItems = document.querySelectorAll(".shop-item");

    filterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            // Remove active class from all
            filterBtns.forEach((b) =>
                b.classList.remove("active", "btn-primary"),
            );
            filterBtns.forEach((b) => b.classList.add("btn-outline-primary"));

            // Add active to clicked
            btn.classList.remove("btn-outline-primary");
            btn.classList.add("active", "btn-primary");

            const filterValue = btn.getAttribute("data-filter");

            shopItems.forEach((item) => {
                // Cast to HTMLElement to access dataset safely
                const itemEl = item as HTMLElement;
                if (
                    filterValue === "All" ||
                    itemEl.dataset.category === filterValue
                ) {
                    itemEl.style.display = "block";
                } else {
                    itemEl.style.display = "none";
                }
            });
        });
    });

    // Set 'All' as active by default
    const allBtn = document.querySelector('[data-filter="All"]');
    if (allBtn) {
        allBtn.classList.remove("btn-outline-primary");
        allBtn.classList.add("active", "btn-primary");
    }
</script>
